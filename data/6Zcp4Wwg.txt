<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN" "http://www.w3.org/TR/REC-html40/loose.dtd">
<html><body><p>// The DPCM decoder from ID_SD in Keen Dreams for Steam

static SDL_mutex *sd_mutex;

// Custom DPCM decoder (cut filesize in half)
void SD_SDL_DecodeSound(int16_t *dest, int16_t *src, int lenInSamples)
{
	while (lenInSamples--)
	{
		*dest = (*src + soundPrev) + soundDiff;
		soundDiff = *dest - soundPrev;
		soundPrev = *dest;
		src++;
		dest++;
	}
}


void SD_SDL_CallBack(void *unused, Uint8 *stream, int len)
{
	int16_t *currSamplePtr = (int16_t *)stream;
	uint32_t currNumOfSamples;
	boolean isPartCompleted;
#if SDL_VERSION_ATLEAST(1,3,0)
	memset(stream, 0, len);
#endif
	SDL_LockMutex(sd_mutex);
	if (!SoundPriority)
	{
		SDL_UnlockMutex(sd_mutex);
		return;
	}
	
	uint32_t length = SDL_SwapLE32(*(uint32_t *)(SoundTable[SoundNumber])) + 6;
	int lenToCopy = SDL_min(len, length - SD_SDL_SampleOffsetInSound);
	SD_SDL_DecodeSound(stream, SoundTable[SoundNumber] + SD_SDL_SampleOffsetInSound, lenToCopy/2);
	SD_SDL_SampleOffsetInSound += lenToCopy;
	if (SD_SDL_SampleOffsetInSound &gt;= length)
	{
		SoundNumber = 0;
		SoundPriority = 0;
	}
	SDL_UnlockMutex(sd_mutex);
}</p></body></html>
